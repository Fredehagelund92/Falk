# falk Configuration
# Single source for agent behavior, extensions, and access control.
# Metrics and dimensions are defined in semantic_models.yaml (Boring Semantic Layer)

version: 1

# Project Metadata
project:
  name: my-falk-project
  description: AI-powered data agent for metric queries

# Database Connection (inline — no separate profiles file)
connection:
  type: duckdb
  database: data/warehouse.duckdb

# BigQuery: type: bigquery, project_id: your-project, dataset_id: analytics
# Snowflake: type: snowflake, user: ..., password: ${SNOWFLAKE_PASSWORD}, account: ..., database: ..., schema: ...

# Agent Configuration (analyst-facing)
agent:
  # LLM Provider
  provider: openai  # openai, anthropic, gemini, mistral
  model: gpt-5-mini  # or gpt-5-nano, claude-sonnet-4, gemini-pro, etc.
  
  # Business Context - This is your company's data story
  context: |
    We're a SaaS company selling analytics software.
    The funnel is: trials -> signups -> paid customers -> revenue.
    "Customer" = organization using our software.
  
  # Example Questions - Help users know what to ask
  examples:
    - "What's our revenue by region this month?"
    - "Show me top 5 customers by trials"
    - "Compare this week to last week"
    - "Daily breakdown of conversions"
  
  # Rules - Important constraints the agent should follow
  rules:
    - "Revenue data has a 24-hour processing delay"
    - "Always mention the date range when showing results"
    - "Use 'MRR' not 'monthly recurring revenue'"
  
  # Global gotchas (optional) - caveats not tied to one metric/dimension
  gotchas:
    - "Data from the current day may be incomplete until the daily pipeline finishes"
  
  # Welcome Message
  welcome: |
    Hi! I can help you explore your data.
    Try asking:
    - "What's our revenue by region?"
    - "Show me top customers"

  # Optional custom prompt sections (advanced)
  custom_sections:
    - title: Reporting Conventions
      content: |
        - Use USD unless the user asks for another currency.
        - Round percentages to one decimal place.
  
  # Knowledge files loaded into the system prompt
  knowledge:
    enabled: true
    business_path: knowledge/business.md
    gotchas_path: knowledge/gotchas.md
    load_mode: startup  # startup (phase 1), on_demand reserved for future

  # include_semantic_metadata_in_prompt: true   # true = synonyms + gotchas in prompt (default)
  # false = smaller prompt; agent uses list_catalog/describe_metric for discovery

  # Custom Python tool extensions (project modules with FunctionToolset)
  # extensions:
  #   tools:
  #     - module: project_tools.customer_health
  #     - module: project_tools.forecasting
  #     - module: project_tools.alerts
  #       enabled: false

# Observability: set LOGFIRE_TOKEN in .env to enable Logfire tracing

# Long-term memory (optional, disabled by default)
# memory:
#   enabled: false
#   provider: hindsight  # requires hindsight package + HINDSIGHT_API_KEY

# Paths (relative to project root)
paths:
  semantic_models: semantic_models.yaml  # BSL file

# Session State Storage
session:
  store: memory  # memory (default) or postgres (production)
  postgres_url: ${POSTGRES_URL}  # Required for postgres; set in .env
  schema: falk_session
  ttl: 3600  # Session TTL in seconds (1 hour)
  maxsize: 500  # Max sessions for memory store (when store=memory)

# Slack policy (optional — defaults to DM-only exports)
slack:
  exports_dm_only: true

# Advanced Settings (technical — hidden from analyst config)
advanced:
  auto_run: false  # Reserved for future use
  max_tokens: 4096
  temperature: 0.1
  max_rows_per_query: 10000
  query_timeout_seconds: 30   # warehouse/tool execution (e.g. query_metric)
  model_timeout_seconds: 60   # LLM request (single turn)
  slack_run_timeout_seconds: 120  # Whole Slack run (model + tools)
  tool_calls_limit: 8   # Max tool calls per run (prevent tool loops)
  request_limit: 6      # Max LLM requests per run
  max_retries: 3
  retry_delay_seconds: 1
  log_level: INFO  # DEBUG, INFO, WARNING, ERROR
  # message_history_max_messages: null   # null = no limit. 12 = keep last 12 messages (reduces tokens in long threads).

# Access Control (optional — uncomment and configure to restrict metric access per user)
# When absent, all users can see and query all metrics and dimensions (open by default).
#
# access_policies:
#   # Role applied to users not listed below. null = open access for unlisted users.
#   default_role: null
#
#   roles:
#     admin:
#       metrics: null       # null = all metrics allowed
#       dimensions: null
#     analyst:
#       metrics:
#         - revenue
#         - orders
#         - average_order_value
#       dimensions:
#         - date
#         - region
#         - product_category
#     viewer:
#       metrics:
#         - revenue
#       dimensions:
#         - date
#         - region
#
#   users:
#     - user_id: alice@company.com   # team member email (easiest to find)
#       roles: [admin]
#     - user_id: bob@company.com
#       roles: [analyst]
#     - user_id: carol@company.com
#       roles: [viewer]
#     # Tip: find emails in Slack → click a profile → "View full profile"

